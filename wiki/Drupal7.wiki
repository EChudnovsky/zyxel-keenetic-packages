#summary Эта статья посвящена вопросу установки CMS Drupal7 на Zyxel Keenetic.

= Введение (*Статья еще не окончена!*)=

В рамках данной статьи мы займемся вопросом установки [http://drupal.org CMS Drupal] на нашем роутере. Все необходимое для этого уже имеется в репозитарии этого проекта и доступно через менеджер пакетов opkg.
У нас имеется быстрый web-сервер [http://www.lighttpd.net/ lighttpd], [http://php.net/ PHP 5.3.6] и встроенная поддержка баз данных в виде библиотеки SQLite3.
Приступим...
----
= Установка =

Прежде чем начать установку web-сервера, PHP и Drupal мы должны определится какие именно пакеты нам нужны. А выбор собственно и не велик - т.к. из всех возможных SQL баз данных у нас имеется только SQLite3, использование которой оправдано малым объемом ОЗУ Keentic-а (только 32Мб), то единственная возможная версией которой мы можем воспользоваться - это Drupal7. Только эта версия умеет работать с широким спектром SQL серверов, включая SQLite3, через универсальный PDO драйвер из комплекта PHP 5.3. Все остальные пакеты которые нам будут необходимы диктуются из [http://drupal.org/requirements минимальных требований Drupal7]. Нужно помнить, что объем ОЗУ сильно ограничен, а скорость обмена со swap-файлом на USB носителе не больше 8Мб/с (и это пиковое значение). Поэтому устанавливайте только те пакеты без которых не обойтись, иначе будут большие задержки с отдачей страниц. Список необходимых пакетов таков:
 * Web-сервер:
  * lighttpd _(сам web-сервер)_,
  * lighttpd-mod-access _(модуль контроля доступа к сайту, можно не использовать при работе с анонимным доступом)_,
  * lighttpd-mod-accesslog _(модуль ведения лога обращения к сайту, пригодиться для отыскания проблем или если вас взломают :))_,
  * lighttpd-mod-cgi _(модуль работы с cgi-скриптами, нужен для fastcgi)_,
  * lighttpd-mod-fastcgi _(модуль интерфейса fastcgi через который устанавливается связь с PHP интерпретатором)_.
 * PHP 5.3 интерпретатор:
  * php5 _(сам интерпретатор)_,
  * php5-cgi _(модуль работы с web-сервер в качестве cgi-скрипта, нужен для fastcgi)_,
  * php5-fastcgi _(модуль работы с web-сервер в через fastcgi)_,
  * php5-mod-dom _(модуль-расширение - HTML DOM, используется Drupal7 core)_,
  * php5-mod-gd _(модуль-расширение - графическая библиотека GD2, используется Drupal7 core)_,
  * php5-mod-hash _(модуль-расширение - построение хеш-сумм и криптография, используется Drupal7 core)_,
  * php5-mod-json _(модуль-расширение - JSON синтаксис, используется Drupal7 core)_,
  * php5-mod-mbstring _(модуль-расширение - UNICODE строки, используется Drupal7 core)_,
  * php5-mod-pdo _(модуль-расширение - PDO универсальный драйвер доступа к SQL базам, используется Drupal7 database API)_,
  * php5-mod-pdo-sqlite _(модуль-расширение - расширение PDO для работы с SQLite/SQLite3, используется Drupal7 database API)_,
  * php5-mod-sqlite3 _(модуль-расширение - прямая работа с библиотекой SQLite3, используется Drupal7 database API)_,
  * php5-mod-session _(модуль-расширение - поддержка HTTP сессий через куки, используется Drupal7 core)_,
  * php5-mod-xml _(модуль-расширение - XML и XML DOM, используется Drupal7 core)_,
  * php5-mod-simplexml _(модуль-расширение - упрощенная работа с XML, используется Drupal7 core, в принципе это аналог модуля php5-mod-xml но Drupal7 использует почему-то и то и другое)_.

Все эти пакеты должны быть установлены в Keenetic-е. Для этого соединяемся с роутером через SSH, заходим под root и выполняем по очереди команду: "*opkg install <имя пакета>*".

Теперь приступим к развертыванию Drupal7. Подготовим для этого место на USB диске Keenetic-а. Для этого на диске нужно создать три каталога:
 * /media/DISK_A1/net/www - _корневой каталог, где будут расположены скрипты Drupal7_,
 * /media/DISK_A1/net/db - _каталог, где будет размещена база данных Drupal7_,
 * /media/DISK_A1/net/log - каталог, где будут расположены логи доступа и ошибок_. 

*Обратите внимание*:
 `Все каталоги расположены вне пути /media/DISK_A1/system, который используется менеджером пакетов opkg и OS linux. Это сделано для большей безопасности в случаи взлома web-сервера. Хотя вы вольны расположить их где угодно, например в базовой конфигурации, которую мы конечно будем менять, www каталог предлагается разместить по пути /media/DISK_A1/system.`

Теперь нужно скачать архив дистрибутива Drupal 7.0 по адресу http://drupal.org/project/drupal и распаковать его в каталог /media/DISK_A1/net/www. Но вызывать Drupal 7 еще рано, прежде нужно настроить конфигурацию lighttpd-сервера, PHP интерпретатора и самого Drupal.

----
= Настройка =

Чтобы все, что мы установили заставить работать - нужно это все сконфигурировать, к чему и приступаем.

*Примечание*:
 `В ходе настройки служб нам нужно будет редактировать их файлы конфигурации. Делать это можно как из под Linux, так и под Windows: единственный нюанс - файлы должны оставаться в Unix-like формате, т.е. код новой строки должен быть LF (так же обозначается \n), а не комбинация CR+LF (\r\n), как принятор для текстовых файлов в Windows`.

== Настройка роутера ==
Прежде чем приступить к настройке lighttpd, php и Drupal нужно изменить кое-что в роутере, а именно: web интерфейс роутера работает на 80-м порту, который пригодится нам для своего сервера. Нужно перевести web интерфейс роутера на другой порт, например на порт 8080. Для этого в разделе "Управление интернет-центром" (Система/Управление) меняем "TCP-порт веб-конфигуратора:" с 80 на 8080. И применяем настройки.

== Настройка lighttpd ==
После установки lighttpd из репозитария его конфигурационный файл находится по пути /media/DISK_A1/system/etc/lighttpd/lighttpd.conf и настроен он работу со статическим контентом по пути /media/DISK_A1/system/www, для примера в этом каталоге лежит файл index.html. Кроме того порт для сервера установлен 81-й. Нас это не устраивает, поэтому будем редактировать конфигурационный файл lighttpd.conf. Для этого, найдите в файле lighttpd.conf следующие директивы и замените их значения на указанные. Если директивы закомментированы (первый символ в строке - #), тогда - разкомментируйте их:
 * Подключаем необходимые модули
{{{
server.modules = ( 
    "mod_rewrite", 
    "mod_redirect",
    "mod_access",
    "mod_cgi",
    "mod_fastcgi",
    "mod_accesslog"
    )
}}}
 * Меняем порт и тэг сервера:
{{{
server.port = 80
server.tag = "lighttpd"
}}}
 * Указываем где сохранять логи работы сервера:
{{{
server.errorlog = "/media/DISK_A1/net/log/lighttpd/error.log" 
accesslog.filename = "/media/DISK_A1/net/log/lighttpd/access.log"
}}}
 * Указываем корневую папку со скриптами сервера:
{{{
server.document-root = "/media/DISK_A1/net/www/"
}}}
 * Корректируем имена индексных файлов папок (добавляем в конец index.php и default.php):
{{{
index-file.names = ( "index.html", "default.html", "index.htm", "default.htm", "index.php", "default.php" ) 
}}}
 * Корректируем правило исключения из набора статических файлов (добавили в конец .inc-файлы, т.е. файлы-вложения, которые используются в php) :
{{{
static-file.exclude-extensions = ( ".php", ".pl", ".fcgi", ".inc" ) 
}}}
 * Указываем путь к pid файлу сервера:
{{{
server.pid-file = "/media/DISK_A1/system/var/run/lighttpd.pid" 
}}}
 * Подключаем php интерпретатор через интерфейс fastcgi:
{{{
fastcgi.server = (
    ".php" => (
        "localhost" => (
           "socket" => "/media/DISK_A1/system/tmp/php-fastcgi.socket",
           "bin-path" => "/media/DISK_A1/system/usr/bin/php-fcgi",
           "bin-environment" => ( 
               "PHP_FCGI_CHILDREN" => "",
               "PHP_FCGI_MAX_REQUESTS" => "100" 
            ),
            "max-procs" => 2,
            "idle-timeout" => 20
        )
    )
) 
}}}
 * Боремся с настырными ботами, которые лазят по инету и пытаются найти и взломать службу phpMyAdmin:
{{{
$HTTP["url"] =~ "(phpmyadmin)+" { url.access-deny = ("") }
$HTTP["url"] =~ "(/scripts/setup.php)+" { url.access-deny = ("") } 
}}}
 * Настраиваем службу url.rewrite, чтобы Drupal мог использовать т.н. CleanURL - очень полезно в наших условиях:
{{{
url.rewrite-if-not-file = (
  "^/system/test/(.*)$" => "/index.php?q=system/test/$1",
  "^/search/node/(.*)$" => "/index.php?q=search/node/$1",
  "^/(.*)\?(.*)$" => "/index.php?q=$1&$2",
  "^/(.*)$" => "/index.php?q=$1"
)
}}}

Все настройки из перечисленных выше, кроме последней, являются общими и не связаны с CMS Drupal. Они отлично подойдут вам, если вы захотите использовать какую-либо другую CMS или свои скрипты.

На настройке fastcgi нужно остановиться и объяснить ее подробнее.
----
= Завершение =